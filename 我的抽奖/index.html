<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>抽奖</title>

<style>
    html,
    body {
        margin: 0;
        padding: 0;
        /* overflow: hidden; */
    }

    body {
        background: url(images/bg_red.jpg) 0px 0px;
        background-size: cover;
    }

    .main_bg {
        /* background: url(images/main_bg.jpg) top center no-repeat; */
        /* height: 1000px; */
    }

    .main {
        width: 1200px;
        /* height: 1000px; */
        /* position: relative; */
        margin: 0 auto;
        /* background-color: blue; */
        /* opacity: 0.1 */
    }

    .num_box {
        width: 1200px;
        /* height: 600px; */
        /* position: absolute; */
        /* top: 120px; */
        /* margin-top: 100px; */
        z-index: 8;
        overflow: hidden;
        text-align: center;
        /* background-color: red; */
        /* opacity: 0.5 */
    }

    .num {
        background: top center repeat-y;
        width: 200px;
        height: 250px;
        float: left;
        margin-left: 33px;
        margin-top: 25px;
        background-color: white;
        overflow: hidden;
        /* opacity: 0.5 */
    }

    .persons {
        width: 200px;
        /* height: 2500px; */
        background-color: white
    }

    .person {
        width: 200px;
        height: 250px;
        color: slategray;
    }

    .btn {
        background: url(images/btn_start.png);
        margin: 0 auto;
        margin-top: 50px;
        width: 264px;
        height: 89px;
        z-index: 9999
    }

    .setting {
        margin: 0 auto;
        margin-top: 0px;
        height: 80px;
        float: left;
        z-index: 999;
        padding-top: 20px;
        padding-left: 30px;
    }

    select,
    #prize-count {
        height: 28px;
    }

    input.text {
        text-align: center
    }

    #prize-count {
        width: 50px;
    }

    #winners {
        width: 1100px;
        background: white;
        opacity: 0.5;
        margin-top: 20px;
        padding: 50px;
    }

    .prizeDetail {
        min-height: 100px;
    }

    .prizeDetail>label {
        color: red;
        font-size: 2em;
    }

    .prizeDetail>span {
        margin-left: 20px;
    }

    .top_head {
        /* position: absolute; */
        width: 1500px;
        margin: 0 auto;
    }

    #top_left {
        float: left;
    }

    #top_right {
        float: right;
    }

    .waist {
        width: 1200px;
        height: 100px;
    }

    .waist_left {
        float: left;
        position: absolute;
        margin-left: -130px;
        z-index: 9999;
        width: 150px;
        height: 150px;
    }

    .waist_right {
        float: right;
        margin-right: -70px;
        z-index: 9999;
        width: 150px;
        height: 150px;
    }

    .waist_left>img,
    .waist_right>img {
        width: 150px;
        height: 150px;
    }
</style>

<body>
    <div class="main_bg">
        <div class="top_head">
            <img id="top_left" src="images/lantern-left.png" />
            <img id="top_right" src="images/lantern-right.png" />
        </div>
        <div class="main">
            <div id="res" style="text-align:center;color:#fff;padding-top:15px;"></div>
            <div class="num_box">
            </div>
            <div>
                <div class="setting">
                    <select id="prize-level">
                        <option value="-1">等级</option>
                        <option value="0">特等奖</option>
                        <option value="1">一等奖</option>
                        <option value="2">二等奖</option>
                        <option value="3">三等奖</option>
                        <option value="4">四等奖</option>
                        <option value="5">五等奖</option>
                        <option value="6">阳光普照奖</option>
                    </select>
                    <select id="prize-detail">
                        <option value="-1">请选择奖品</option>
                        <option value="电纸书Kindle" hidden prize-level="0" prize-count="2">电纸书Kindle</option>
                        <option value="MK钱包" hidden prize-level="1" prize-count="4">MK钱包</option>
                        <option value="小米净化器" hidden prize-level="1" prize-count="2">小米净化器</option>
                        <option value="移动硬盘" hidden prize-level="2" prize-count="5">移动硬盘</option>
                        <option value="电动牙刷" hidden prize-level="2" prize-count="5">电动牙刷</option>
                        <option value="护肤品" hidden prize-level="3" prize-count="6">护肤品</option>
                        <option value="耳麦" hidden prize-level="3" prize-count="4">耳麦</option>
                        <option value="键盘" hidden prize-level="4" prize-count="5">键盘</option>
                        <option value="电饭锅" hidden prize-level="4" prize-count="6">电饭锅</option>
                        <option value="飞利浦剃须刀" hidden prize-level="4" prize-count="4">飞利浦剃须刀</option>
                        <option value="充电宝" hidden prize-level="5" prize-count="10">充电宝</option>
                        <option value="蓝牙耳机" hidden prize-level="5" prize-count="5">蓝牙耳机</option>
                        <option value="现金红包" hidden prize-level="6" prize-count="64">现金红包</option>
                    </select>
                    <span style="color:gray;margin-left:10px;">奖品数量</span>
                    <input id="prize-count" text-align:center; value="10" readonly/>
                </div>
                <div class="btn"></div>
            </div>
            <div class="waist">
                <div class="waist_left">
                    <img src="images/jump-left.png" />
                </div>
                <div class="waist_right">
                    <img src="images/jump-right.png" />
                </div>
            </div>
            <div id="winners">
                <div class="prizeDetail" id="prizeLevel0">
                    <label>特等奖</label>
                </div>
                <div class="prizeDetail" id="prizeLevel1">
                    <label>一等奖</label>
                </div>
                <div class="prizeDetail" id="prizeLevel2">
                    <label>二等奖</label>
                </div>
                <div class="prizeDetail" id="prizeLevel3">
                    <label>三等奖</label>
                </div class="prizeDetail">
                <div class="prizeDetail" id="prizeLevel4">
                    <label>四等奖</label>
                </div>
                <div class="prizeDetail" id="prizeLevel5">
                    <label>五等奖</label>
                </div>
                <div class="prizeDetail" id="prizeLevel6">
                    <label>阳光普照奖</label>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script src="js/jquery-1.11.3.min.js"></script>

<link rel="stylesheet" href="slotMachine/jquery.slotmachine.css" type="text/css" media="screen" />
<script id="slotjs" src="slotMachine/jquery.slotmachine.js"></script>
<script src="js/data.js"></script>
<script>
    var isBegin = false;
    var tempRandom = [];
    var personHtml = "";
    function initMachine(count) {
        reloadJs("slotjs")
        initPage(count)
        //var personHtml = serializePersonHtml()
        addPersonHtml2Unit(personHtml)
    }

    $(function () {
        personHtml = serializePersonHtml()
        initMachine(10)
        $(".btn").click(function () {
            var prizeDetail = $('#prize-detail').val()
            if ($('#prize-level').val() == -1 || prizeDetail == -1) {
                alert('请选择奖品等级和类型')
                return
            }
            if (judgePrized(prizeDetail)) {
                alert(prizeDetail + "已经抽过了")
                return
            }
            if (!isBegin) {
                var randoms = getRandomByCount($("#prize-count").val())
                serializeMachine(randoms);
                scrollMachine(randoms)
                isBegin = true
                $(this).css("background-image", "url(images/btn_stop.png)")
                tempRandom = randoms;
               
            } else {
                stopMachine()
                isBegin = false
                $(this).css("background-image", "url(images/btn_start.png)")
                showPanel(tempRandom)
                tempRandom = [];
            }
        });

        //选择奖品等级、个数
        $("#prize-level").change(function () {
            var prizeLevel = $(this).val();
            $("#prize-detail").find("option").each(function (index, element) {
                $(element).removeAttr("hidden")
                if (prizeLevel != $(element).attr("prize-level")) {
                    $(element).attr("hidden", "true")
                }
            })
            $("#prize-detail").val("-1")
        })
        $("#prize-detail").change(function () {
            var optionSelected = $(this).find("option:selected")
            var prizecount = optionSelected.attr("prize-count")
            $("#prize-count").val(prizecount)
            initMachine(prizecount)
        })
    });

    //初始化人员DIV长条
    function serializePersonHtml() {
        var personsHtml = '<div class="persons">';
        for (let index = 0; index < data.length; index++) {
            var p = data[index]
            //console.log(p.id + p.name + p.jobNo)
            personsHtml += '<div class="person" id="' + p.id + '"><div><img width="200px" height="200px" src="photo/' + p.id + p.name + '.jpg" />'
                + '<div style="height:50px;text-align:center">' + p.id + p.jobNo + ' <br/> ' + p.name + '</div></div></div>'
        }
        personsHtml += '</div>'
        return personsHtml
    }

    //初始化页面
    function initPage(count) {
        tempRandom = [];
        tempMachines = [];

        var pageHtml = "";
        for (let index = 0; index < count; index++) {
            pageHtml += '<div class="num"></div>'
        }
        $(".num_box").html(pageHtml)
    }

    //给每个格子加入HTML
    function addPersonHtml2Unit(personHtml) {
        $('.num').each(function (index, element) {
            $(element).html(personHtml)
        })
    }

    var tempMachines = [];
    //初始化老虎机
    function serializeMachine(randoms) {
        tempMachines.forEach((value, index, arr) => {
            value.destroy();
        })
        tempMachines = [];
        $(".persons").each(function (index, element) {
            var machinetemp = $(element).slotMachine({
                active: 0,
                delay: 1000,
                direction: 'up',
                randomize: function (activeElementIndex) {
                    return randoms[index].id - 1;
                }
            });
            tempMachines.push(machinetemp)
        })
    }

    //翻滚吧
    function scrollMachine(randoms) {
        var index = 0;
        tempMachines.forEach(m => {
            //m.futureActive = randoms[index].id - 1
            m.shuffle()
            console.log(index + JSON.stringify(randoms[index]))
            index++
        });
    }

    //停止翻滚
    function stopMachine() {
        var index = 0
        tempMachines.forEach(m => {
            setTimeout(function () {
                m.stop()
                console.log(m.active)
            }, index * 1000)
            index++
        });
    }

    //未获奖的
    var nowins = data;
    //获奖的
    var winners = [];
    //抽人
    function getRandomByCount(count) {
        var randoms = []
        while (count--) {
            var arrIndex = Math.floor(Math.random() * nowins.length);
            winners.push(nowins[arrIndex])
            randoms.push(nowins[arrIndex])
            nowins.splice(arrIndex, 1);
            //console.log(count)
            if (count == 0) break;
        }
        //console.log(JSON.stringify(winners))
        return randoms
    }

    //获奖区域面板
    function showPanel(randoms) {
        var prizeLevel = $("#prize-level").val();
        var prizeDetail = $("#prize-detail").val();
        var index = 0;
        randoms.forEach(p => {
            var html = '<span>' + p.name + '(' + prizeDetail + ')</span>'
            setTimeout(function () {
                $('#prizeLevel' + prizeLevel).append(html)
            }, (index + 1) * 1000 + 1000)
            index++
        })
    }

    //判断这种类型的奖品是否已经抽过
    function judgePrized(prize) {
        var html = $("#winners").html()
        return html.indexOf(prize) > -1
    }

    var reloadJs = function (id) {
        var jsObj = document.getElementById(id);
        var src = jsObj.src;
        delete jsObj;
        //重新加载
        var script = document.createElement('script');
        script.src = src;
        document.body.appendChild(script);
    };
</script>