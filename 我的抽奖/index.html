<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>抽奖</title>

<style>
    html,
    body {
        margin: 0;
        padding: 0;
        /* overflow: hidden; */
    }

    body {
        background: url(images/body_bg.jpg) 0px 0px repeat-x;
    }

    .main_bg {
        background: url(images/main_bg.jpg) top center no-repeat;
        height: 1000px;
    }

    .main {
        width: 1200px;
        height: 1000px;
        position: relative;
        margin: 0 auto;
        /* background-color: blue; */
        /* opacity: 0.1 */
    }

    .num_box {
        width: 1200px;
        height: 600px;
        position: absolute;
        top: 120px;
        z-index: 8;
        overflow: hidden;
        text-align: center;
        /* background-color: red; */
        /* opacity: 0.5 */
    }

    .num {
        background: top center repeat-y;
        width: 200px;
        height: 250px;
        float: left;
        margin-left: 33px;
        margin-top: 25px;
        background-color: white;
        overflow: hidden;
        /* opacity: 0.5 */
    }

    .persons {
        width: 200px;
        /* height: 2500px; */
        background-color: white
    }

    .person {
        width: 200px;
        height: 250px;
    }

    .btn {
        background: url(images/btn_start.png);
        margin: 0 auto;
        margin-top: 750px;
        width: 264px;
        height: 89px;
        z-index: 9999
    }
</style>

<body>
    <div class="main_bg">
        <div class="main">
            <div id="res" style="text-align:center;color:#fff;padding-top:15px;"></div>
            <div class="num_box">
            </div>
            <div class="btn"></div>
        </div>
        <div id="winners">
            
        </div>
    </div>
    
</body>

</html>
<script src="js/jquery-1.11.3.min.js"></script>
<script src="js/easing.js"></script>
<link rel="stylesheet" href="slotMachine/jquery.slotmachine.css" type="text/css" media="screen" />
<script src="slotMachine/jquery.slotmachine.js"></script>
<script src="js/data.js"></script>
<script>
    var isBegin = false;

    function initMachine(count){
        initPage(count)
        var personHtml = serializePersonHtml()
        addPersonHtml2Unit(personHtml)
        serializeMachine();
    }

    $(function () {
        var count = 8
        initMachine(count)
        $(".btn").click(function () {
            if (!isBegin) {
                var randoms = getRandomByCount(count)
                scrollMachine(randoms)
                isBegin = true
            } else {
                stopMachine()
                isBegin = false
            }
        });
    });

    //初始化人员DIV长条
    function serializePersonHtml() {
        var personsHtml = '<div class="persons" id="person1">';
        for (let index = 0; index < data.length; index++) {
            const p = data[index]
            //console.log(p.id + p.name + p.jobNo)
            personsHtml += '<div class="person"><div><img width="200px" height="200px" src="photo/' + p.id + p.name + '.jpg" />'
                + '<div style="height:50px;text-align:center">' + p.id + p.name + p.jobNo + '</div></div></div>'
        }
        personsHtml += '</div>'
        return personsHtml
    }

    //初始化页面
    function initPage(count){
        var pageHtml = "";
        for (let index = 0; index < count; index++) {
            pageHtml += '<div class="num"></div>'
        }
        $(".num_box").html(pageHtml)
    }

    //给每个格子加入HTML
    function addPersonHtml2Unit(personHtml) {
        $('.num').each(function (index, element) {
            $(element).html(personHtml)
        })
    }

    var machines = [];
    //初始化老虎机
    function serializeMachine() {
        $(".persons").each(function (index, element) {
            var machine = $(element).slotMachine({
                active: 0,
                delay: 1000,
                stopHidden: false,
                direction: 'up'
            });
            machines.push(machine)
        })
    }

    //翻滚吧
    function scrollMachine(randoms) {
        var index = 0;
        machines.forEach(m => {
            m.shuffle()
            m.futureActive = randoms[index].id - 1
            index++
        });
    }

    //停止翻滚
    function stopMachine() {
        var index = 0
        machines.forEach(m => {
            setTimeout(function () {
                m.stop()
            }, 1000 * index)
            index++
        });
    }

    //未获奖的
    var nowins = data;
    //获奖的
    var winners = [];
    //抽人
    function getRandomByCount(count) {
        var randoms = []
        while (count--) {
            var arrIndex = Math.floor(Math.random() * nowins.length);
            winners.push(nowins[arrIndex])
            randoms.push(nowins[arrIndex])
            nowins.splice(arrIndex, 1);
            console.log(count)
            if (count == 0) break;
        }
        console.log(JSON.stringify(winners))
        return randoms
    }

</script>